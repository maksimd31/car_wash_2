{% extends 'base_reg.html' %}

{% block content %}
<form method="post" id="timeForm">
    {% csrf_token %}
    <button type="submit" name="start" id="startButton">Старт</button>
    <button type="submit" name="stop" id="stopButton" disabled>Стоп</button>
    <button type="submit" name="reset" style="background-color: red; color: white;">Обнулить данные</button>
</form>

<h2>Таймер: <span id="timer">00:00:00</span></h2>

<h2>Интервалы времени</h2>
<div class="table-responsive">
    <table class="table table-striped table-hover table-bordered">
        <thead class="table-dark">
        <tr>
            <th scope="col">Старт</th>
            <th scope="col">Стоп</th>
            <th scope="col">Длительность</th>
        </tr>
        </thead>
        <tbody>
        {% for interval in formatted_intervals %}
        <tr>
            <td>{{ interval.start_time }}</td>
            <td>{{ interval.end_time }}</td>
            <td>{{ interval.duration }}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<h2>Итоги по дням</h2>
<div class="table-responsive">
    <table class="table table-striped table-hover table-bordered">
        <thead class="table-dark">
        <tr>
            <th scope="col">Дата</th>
            <th scope="col">Количество интервалов</th>
            <th scope="col">Итоговое время</th>
        </tr>
        </thead>
        <tbody>
        {% for summary in daily_summary %}
        <tr>
            <td>{{ summary.date }}</td>
            <td>{{ summary.interval_count }}</td>
            <td>
                {% if summary.total_duration %}
                {{ summary.total_duration|time:"H:i:s" }}
                {% else %}
                00:00:00
                {% endif %}
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<script>
    let timerInterval;
    let seconds = 0;

    document.getElementById('startButton').addEventListener('click', function(event) {
        event.preventDefault(); // Предотвращаем отправку формы
        this.disabled = true; // Отключаем кнопку "Старт"
        document.getElementById('stopButton').disabled = false; // Включаем кнопку "Стоп"

        // Отправляем запрос на сервер для начала интервала
        fetch("{% url 'time_interval_view' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'start=1'
        });

        timerInterval = setInterval(function() {
            seconds++;
            const hours = String(Math.floor(seconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
            const secs = String(seconds % 60).padStart(2, '0');
            document.getElementById('timer').textContent = `${hours}:${minutes}:${secs}`;
        }, 1000);
    });

    document.getElementById('stopButton').addEventListener('click', function(event) {
        event.preventDefault(); // Предотвращаем отправку формы
        clearInterval(timerInterval);
        this.disabled = true; // Отключаем кнопку "Стоп"
        document.getElementById('startButton').disabled = false; // Включаем кнопку "Старт"

        // Отправляем запрос на сервер для остановки интервала
        fetch("{% url 'time_interval_view' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'stop=1'
        });
    });
</script>

{% endblock %}
